<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethereum - Live Chart</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-8">
    <div class="max-w-6xl mx-auto">
        <!-- ヘッダー -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold mb-2">Ethereum (ETH)</h1>
            <div class="flex items-center gap-4">
                <p class="text-3xl font-semibold" id="currentPrice">Loading...</p>
                <p class="text-lg" id="priceChange"></p>
            </div>
            <p class="text-sm text-gray-400 mt-2">Last updated: <span id="lastUpdate">-</span></p>
        </div>

        <!-- Chart -->
        <div class="bg-gray-800 rounded-lg p-6 shadow-xl">
            <canvas id="ethChart"></canvas>
        </div>

        <!-- Debug information -->
        <div class="mt-4 text-sm text-gray-500">
            <p>Data points: <span id="dataCount">0</span></p>
            <p class="text-red-400" id="errorMsg"></p>
        </div>
    </div>

    <script>
        const ctx = document.getElementById('ethChart').getContext('2d');
        const priceData = [];
        const timeLabels = [];

        // Chart.js settings
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'ETH/USD',
                    data: priceData,
                    borderColor: 'rgb(99, 102, 241)',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 2,
                    pointHoverRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        ticks: {
                            color: '#9ca3af',
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        },
                        grid: {
                            color: 'rgba(75, 85, 99, 0.3)'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#9ca3af',
                            maxTicksLimit: 10
                        },
                        grid: {
                            color: 'rgba(75, 85, 99, 0.3)'
                        }
                    }
                }
            }
        });

        // Show error message
        function showError(message) {
            document.getElementById('errorMsg').textContent = message;
            console.error(message);
        }

        // Load historical data with better error handling
        async function loadHistoricalData() {
            try {
                console.log('Loading historical data...');
                
                const response = await fetch(
                    'https://api.coingecko.com/api/v3/coins/ethereum/market_chart?vs_currency=usd&days=1&interval=hourly',
                    {
                        headers: {
                            'Accept': 'application/json'
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Historical data loaded:', data);

                if (!data.prices || data.prices.length === 0) {
                    throw new Error('No price data received');
                }

                // Process historical price data
                const prices = data.prices;
                
                prices.forEach(([timestamp, price]) => {
                    const date = new Date(timestamp);
                    const timeStr = date.toLocaleTimeString('ja-JP', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    timeLabels.push(timeStr);
                    priceData.push(price);
                });

                chart.update();
                document.getElementById('dataCount').textContent = timeLabels.length;
                
                // Fetch current price
                await fetchCurrentPrice();
            } catch (error) {
                console.error('Error loading historical data:', error);
                showError('Historical data load failed: ' + error.message);
                
                // If historical data fails, try to at least get current price
                await fetchCurrentPrice();
            }
        }

        // Fetch current ETH price
        async function fetchCurrentPrice() {
            try {
                console.log('Fetching current price...');
                const response = await fetch(
                    'https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd&include_24hr_change=true',
                    {
                        headers: {
                            'Accept': 'application/json'
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Current price data:', data);
                
                if (!data.ethereum) {
                    throw new Error('No Ethereum data in response');
                }

                const price = data.ethereum.usd;
                const change = data.ethereum.usd_24h_change;

                // Update current price
                document.getElementById('currentPrice').textContent = 
                    '$' + price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                
                // Update price change
                const changeElement = document.getElementById('priceChange');
                const changeText = change.toFixed(2) + '%';
                changeElement.textContent = (change >= 0 ? '↑ +' : '↓ ') + changeText;
                changeElement.className = change >= 0 ? 'text-green-500 text-lg' : 'text-red-500 text-lg';

                // Update last update time
                const now = new Date();
                document.getElementById('lastUpdate').textContent = now.toLocaleTimeString('ja-JP');

                // Add new data point to chart
                const timeStr = now.toLocaleTimeString('ja-JP', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                timeLabels.push(timeStr);
                priceData.push(price);

                // Keep max 60 data points
                if (timeLabels.length > 60) {
                    timeLabels.shift();
                    priceData.shift();
                }

                document.getElementById('dataCount').textContent = timeLabels.length;
                chart.update();
                console.log('Chart updated successfully');
            } catch (error) {
                console.error('Error fetching price:', error);
                showError('Price fetch failed: ' + error.message);
                document.getElementById('currentPrice').textContent = 'Error';
            }
        }

        // Initial load
        loadHistoricalData();

        // Update every 60 seconds (changed from 30 to avoid rate limits)
        setInterval(fetchCurrentPrice, 60000);

        console.log('ETH chart initialized');
    </script>
</body>
</html>
